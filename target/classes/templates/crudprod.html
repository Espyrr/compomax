<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compomax - Mantenimiento de Productos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div th:replace="~{cabecera :: cabecera}"></div>
  <div th:replace="~{menu_nav :: menu_nav}"></div>

  <main class="container bg-white p-4 rounded">
    <h1 class="text-center mb-4">Mantenimiento de Productos</h1>

    <div th:if="${mensaje != null}" class="alert alert-success" th:text="${mensaje}"></div>
    <div th:if="${error != null}" class="alert alert-danger" th:text="${error}"></div>

    <form class="row g-3" th:action="@{/productos/guardar}" method="post" enctype="multipart/form-data">
	  <div class="col-md-6">
	    <label class="form-label">Código</label>
	    <input type="text" class="form-control" th:field="*{producto.idProducto}" placeholder="P0000" pattern="[Pp][0-9]{4}" required/>
	  </div>

      <div class="col-md-6">
        <label class="form-label">Descripción</label>
        <input type="text" class="form-control" th:field="*{producto.descripcion}" required/>
      </div>

      <div class="col-md-6">
        <label class="form-label">Stock</label>
        <input type="number" class="form-control" th:field="*{producto.stock}" min="0" required/>
      </div>

      <div class="col-md-6">
        <label class="form-label">Precio</label>
        <input type="number" class="form-control" th:field="*{producto.precio}" min="0" step="0.01" required/>
      </div>

      <div class="col-md-6">
        <label class="form-label">Categoría</label>
        <select class="form-select" th:field="*{producto.idCategoria.idCategoria}" required>
          <option value="" selected>Seleccionar</option>
          <option th:each="cat : ${lstCategorias}" th:value="${cat.idCategoria}" th:text="${cat.descripcion}"
                  th:selected="${producto.idCategoria?.idCategoria} == ${cat.idCategoria}">
          </option>
        </select>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-primary" th:text="${modoEdicion} ? 'Actualizar' : 'Registrar'"></button>
      </div>
    </form>

    <hr />

    <form th:action="@{/productos}" method="get" class="d-flex mb-4">
      <input type="text" name="buscar" class="form-control me-2" placeholder="Buscar productos..." th:value="${buscar}" />
      <button type="submit" class="btn btn-primary">Buscar</button>
    </form>

    <div class="table-responsive">
      <table class="table table-hover w-100">
        <thead class="table-dark">
          <tr>
            <th>Imagen</th>
            <th>Código</th>
            <th>Descripción</th>
            <th>Stock</th>
            <th>Precio</th>
            <th>Categoría</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="p : ${lstProductos}">
            <td>
              <img th:src="@{'/img/productos/' + ${p.idProducto} + '.jpg?' + ${#dates.createNow().time}}"
                   onerror="this.src='/img/productos/vacio.jpg'" width="80px">
            </td>
            <td th:text="${p.idProducto}"></td>
            <td th:text="${p.descripcion}"></td>
            <td th:text="${p.stock}"></td>
            <td th:text="'S/. ' + ${#numbers.formatDecimal(p.precio, 1, 'POINT', 2, 'POINT')}"></td>
            <td th:text="${p.idCategoria.descripcion}"></td>
            <td>
              <a th:href="@{'/productos/editar/' + ${p.idProducto}}" class="btn btn-info mb-1">Editar</a>
			  <button type="button" class="btn btn-danger" th:attr="data-codigo=${p.idProducto}" onclick="confirmarEliminacion(this)">Eliminar</button>
            </td>
          </tr>
          <tr th:if="${#lists.isEmpty(lstProductos)}">
            <td colspan="7" class="text-center text-muted">No hay productos registrados.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <div th:replace="~{footer :: footer}"></div>

  <script>
	function confirmarEliminacion(boton) {
	  const codigo = boton.getAttribute('data-codigo'); // <-- aquí está la clave
	  Swal.fire({
	    title: '¿Está seguro?',
	    text: 'Se eliminará el producto con código ' + codigo,
	    icon: 'warning',
	    showCancelButton: true,
	    confirmButtonText: 'Sí, eliminar',
	    cancelButtonText: 'No, cancelar'
	  }).then((result) => {
	    if (result.isConfirmed) {
	      window.location.href = '/productos/eliminar/' + codigo;
	    }
	  });
	}
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
